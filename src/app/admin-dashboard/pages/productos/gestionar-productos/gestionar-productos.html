<div class="container">
  <!-- Header -->
  <div class="header-container">
    <div>
      <h1 class="header-title">Gestionar Productos</h1>
      <p class="header-subtitle">Administra el cat√°logo de productos del sistema</p>
    </div>
    <button class="btn-nuevo-producto" (click)="handleOpenModal('create')">
      + Nuevo Producto
    </button>
  </div>

  <!-- Mensajes -->
  @if (hasError() && !showModal()) {
    <div class="mensaje-error">{{ hasError() }}</div>
  }
  @if (success() && !showModal()) {
    <div class="mensaje-exito">{{ success() }}</div>
  }

  <!-- Estad√≠sticas -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üì¶</div>
      <div class="stat-content">
        <span class="stat-label">Total Productos</span>
        <span class="stat-value">{{ productos().length }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-content">
        <span class="stat-label">Disponibles</span>
        <span class="stat-value">{{ productosDisponibles() }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">‚ö†Ô∏è</div>
      <div class="stat-content">
        <span class="stat-label">Stock Bajo</span>
        <span class="stat-value">{{ productosStockBajo() }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-content">
        <span class="stat-label">Agotados</span>
        <span class="stat-value">{{ productosAgotados() }}</span>
      </div>
    </div>
  </div>

  <!-- Buscador -->
  <div class="search-container">
    <input
      #searchInput
      type="text"
      placeholder="Buscar por nombre, c√≥digo o descripci√≥n..."
      [value]="searchTerm()"
      (input)="searchTerm.set(searchInput.value)"
      class="search-input"
    />
    <span class="search-icon">üîç</span>
  </div>

  <!-- Tabla -->
  <div class="table-container">
    <table class="productos-table">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Producto</th>
          <th>Precio</th>
          <th>Stock Actual</th>
          <th>Stock M√≠nimo</th>
          <th>Unidad</th>
          <th>Estado Stock</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @if (productosFiltrados().length === 0) {
          <tr>
            <td colspan="9" class="no-data">
              {{ searchTerm() ? 'No se encontraron productos' : 'No hay productos registrados' }}
            </td>
          </tr>
        } @else {
          @for (producto of productosFiltrados(); track producto.id) {
            <tr>
              <td>
                <span class="codigo-producto">{{ producto.codigo }}</span>
              </td>
              <td>
                <div class="producto-info">
                  <strong class="producto-nombre">{{ producto.nombre }}</strong>
                  @if (producto.descripcion) {
                    <span class="producto-descripcion">{{ producto.descripcion }}</span>
                  }
                </div>
              </td>
              <td>
                <span class="producto-precio">S/ {{ producto.precio }}</span>
              </td>
              <td>
                <span class="stock-actual">{{ producto.stockActual }}</span>
              </td>
              <td>{{ producto.stockMinimo }}</td>
              <td>{{ producto.unidadMedida }}</td>
              <td>
                <span
                  class="badge-stock"
                  [ngClass]="{
                    'badge-agotado': producto.stockActual === 0,
                    'badge-bajo': producto.stockActual > 0 && producto.stockActual <= producto.stockMinimo,
                    'badge-ok': producto.stockActual > producto.stockMinimo
                  }"
                >
                  {{
                    producto.stockActual === 0
                      ? 'Agotado'
                      : producto.stockActual <= producto.stockMinimo
                      ? 'Bajo'
                      : 'OK'
                  }}
                </span>
              </td>
              <td>
                <span
                  class="badge-estado"
                  [ngClass]="{
                    'badge-activo': producto.estado === 'activo',
                    'badge-inactivo': producto.estado === 'inactivo'
                  }"
                >
                  {{ producto.estado === 'activo' ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td>
                <div class="acciones-container">
                  <button
                    class="btn-editar"
                    (click)="handleOpenModal('edit', producto)"
                    title="Editar"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button
                    class="btn-eliminar"
                    (click)="handleDelete(producto.id)"
                    title="Eliminar"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>
</div>

<!-- Modal -->
@if (showModal()) {
  <div class="modal-overlay" (click)="handleCloseModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="modal-header">
        <h2 class="modal-title">
          {{ modalMode() === 'create' ? 'Nuevo Producto' : 'Editar Producto' }}
        </h2>
        <button class="modal-close" (click)="handleCloseModal()">‚úï</button>
      </div>

      <!-- Formulario -->
      <form (ngSubmit)="handleSubmit()">
        <div class="modal-body">
          <!-- Mensajes -->
          @if (hasError()) {
            <div class="mensaje-error">{{ hasError() }}</div>
          }
          @if (success()) {
            <div class="mensaje-exito">{{ success() }}</div>
          }

          <!-- Grid del formulario -->
          <div class="form-grid">
            <!-- C√≥digo -->
            <div class="form-group">
              <label class="form-label">C√≥digo *</label>
              <input
                type="text"
                name="codigo"
                [ngModel]="dataForm().codigo"
                (ngModelChange)="updateFormField('codigo', $event)"
                required
                placeholder="Ej: PROD001"
                [disabled]="modalMode() === 'edit'"
                class="form-input"
              />
            </div>

            <!-- Nombre -->
            <div class="form-group">
              <label class="form-label">Nombre *</label>
              <input
                type="text"
                name="nombre"
                [ngModel]="dataForm().nombre"
                (ngModelChange)="updateFormField('nombre', $event)"
                required
                placeholder="Ej: Coca Cola 1.5L"
                class="form-input"
              />
            </div>

            <!-- Descripci√≥n -->
            <div class="form-group full-width">
              <label class="form-label">Descripci√≥n</label>
              <textarea
                name="descripcion"
                [ngModel]="dataForm().descripcion"
                (ngModelChange)="updateFormField('descripcion', $event)"
                placeholder="Descripci√≥n del producto"
                rows="3"
                class="form-textarea"
              ></textarea>
            </div>

            <!-- Precio -->
            <div class="form-group">
              <label class="form-label">Precio Unitario *</label>
              <input
                type="number"
                name="precio"
                [ngModel]="dataForm().precio"
                (ngModelChange)="updateFormField('precio', $event)"
                required
                step="0.01"
                min="0"
                placeholder="0.00"
                class="form-input"
              />
            </div>

            <!-- Stock Actual -->
            <div class="form-group">
              <label class="form-label">Stock Actual *</label>
              <input
                type="number"
                name="stock_actual"
                [ngModel]="dataForm().stockActual"
                (ngModelChange)="updateFormField('stockActual', $event)"
                required
                min="0"
                placeholder="0"
                class="form-input"
              />
            </div>

            <!-- Stock M√≠nimo -->
            <div class="form-group">
              <label class="form-label">Stock M√≠nimo *</label>
              <input
                type="number"
                name="stock_minimo"
                [ngModel]="dataForm().stockMinimo"
                (ngModelChange)="updateFormField('stockMinimo', $event)"
                required
                min="0"
                placeholder="10"
                class="form-input"
              />
            </div>

            <!-- Unidad de Medida -->
            <div class="form-group">
              <label class="form-label">Unidad de Medida *</label>
              <select
                name="unidad_medida"
                [ngModel]="dataForm().unidadMedida"
                (ngModelChange)="updateFormField('unidadMedida', $event)"
                required
                class="form-select"
              >
                <option value="UND">Unidad</option>
                <option value="MLL">Millar</option>
                <option value="CJA">Caja</option>
                <option value="PTE">Paquete</option>
                <option value="KGR">Kilogramo</option>
                <option value="MLD">Molde</option>
                <option value="SCO">Saco</option>
                <option value="FDO">Fardo</option>
              </select>
            </div>

            <!-- Estado -->
            <div class="form-group">
              <label class="form-label">Estado</label>
              <select
                name="estado"
                [ngModel]="dataForm().estado"
                (ngModelChange)="updateFormField('estado', $event)"
                class="form-select"
              >
                <option value="activo">Activo</option>
                <option value="inactivo">Inactivo</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" (click)="handleCloseModal()" class="btn-cancelar">
            Cancelar
          </button>
          <button type="submit" [disabled]="loading()" class="btn-guardar">
            {{
              loading()
                ? 'Guardando...'
                : modalMode() === 'create'
                ? 'Crear Producto'
                : 'Guardar Cambios'
            }}
          </button>
        </div>
      </form>
    </div>
  </div>
}
