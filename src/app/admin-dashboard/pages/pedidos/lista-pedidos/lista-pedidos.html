<div class="container">
  <div class="header">
    <div>
      <h1>Lista de Pedidos</h1>
      <p>Consulta y gestiona los pedidos registrados en el sistema</p>
    </div>
  </div>

  @if (error()) {
  <div class="errorMessage">{{ error() }}</div>
  } @if (success()) {
  <div class="successMessage">{{ success() }}</div>
  }

  <!-- Estad√≠sticas -->
  <div class="statsCards">
    <div class="statCard">
      <div class="statIcon">üì¶</div>
      <div class="statContent">
        <span class="statLabel">Total Pedidos</span>
        <span class="statValue">{{ pedidos().length }}</span>
      </div>
    </div>

    <div class="statCard">
      <div class="statIcon">üìù</div>
      <div class="statContent">
        <span class="statLabel">Registrados</span>
        <span class="statValue">
          {{ totalPedidosRegistrados() }}
        </span>
      </div>
    </div>

    <div class="statCard">
      <div class="statIcon">‚úÖ</div>
      <div class="statContent">
        <span class="statLabel">Confirmados</span>
        <span class="statValue">
          {{ totalPedidosConfirmados() }}
        </span>
      </div>
    </div>

    <div class="statCard">
      <div class="statIcon">üöö</div>
      <div class="statContent">
        <span class="statLabel">Entregados</span>
        <span class="statValue">
          {{ totalPedidosEntregados() }}
        </span>
      </div>
    </div>
  </div>

  <!-- Controles -->
  <div class="controls">
    <div class="searchBar">
      <input
        #inputSearch
        type="text"
        placeholder="Buscar por cliente o n√∫mero de pedido..."
        [value]="searchTerm()"
        (input)="searchTerm.set(inputSearch.value)"
        class="searchInput"
      />
      <span class="searchIcon">üîç</span>
    </div>

    <div class="filters">
      <button
        class="filterBtn"
        [class.active]="filtroEstado() === 'todos'"
        (click)="filtroEstado.set('todos')"
      >
        Todos
      </button>
      <button
        class="filterBtn"
        [class.active]="filtroEstado() === 'registrado'"
        (click)="filtroEstado.set('registrado')"
      >
        Registrados
      </button>
      <button
        class="filterBtn"
        [class.active]="filtroEstado() === 'confirmado'"
        (click)="filtroEstado.set('confirmado')"
      >
        Confirmados
      </button>
      <button
        class="filterBtn"
        [class.active]="filtroEstado() === 'entregado'"
        (click)="filtroEstado.set('entregado')"
      >
        Entregados
      </button>
    </div>
  </div>

  <!-- Tabla -->
  <div class="tableContainer">
    <table class="table">
      <thead>
        <tr>
          <th>N¬∞ Pedido</th>
          <th>Cliente</th>
          <th>Vendedor</th>
          <th>Fecha</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @if (datosFiltrados().length === 0) {
        <tr>
          <td colspan="7" class="noData">
            {{
              searchTerm() || filtroEstado() !== 'todos'
                ? 'No se encontraron pedidos'
                : 'No hay pedidos registrados'
            }}
          </td>
        </tr>
        } @else { @for (pedido of datosFiltrados(); track pedido.id) {
        <tr>
          <td>
            <span class="pedidoId">#{{ pedido.id }}</span>
          </td>
          <td>
            <div class="clienteInfo">
              <strong>{{ pedido.cliente?.nombreNegocio }}</strong>
              <span>{{ pedido.cliente?.nombreContacto }}</span>
            </div>
          </td>
          <td>{{ pedido.vendedor?.nombre }}</td>
          <td>{{ pedido.fechaPedido | date : 'dd MMM. yyyy, h:mm a' }}</td>
          <td>
            <span class="total">S/ {{ pedido.total | number : '1.2-2' }}</span>
          </td>
          <td>
            <span
              class="badge"
              [ngClass]="{
                  'badgeRegistrado' : pedido.estado === 'registrado',
                  'badgeConfirmado' : pedido.estado === 'confirmado',
                  'badgeEntregado' : pedido.estado === 'entregado',
                  'badgeAnulado' : pedido.estado === 'anulado',
                }"
            >
              {{ pedido.estado }}
            </span>
          </td>
          <td>
            <div class="actions">
              <button class="btnVer" (click)="handleVerDetalle(pedido.id!)" title="Ver Detalle">
                üëÅÔ∏è
              </button>

              @if (pedido.estado !== 'anulado') { @if (pedido.estado === 'registrado') {
              <button
                class="btnConfirmar"
                (click)="handleCambiarEstado(pedido.id!, 'confirmado')"
                title="Confirmar"
              >
                ‚úÖ
              </button>
              } @if (pedido.estado === 'confirmado') {
              <button
                class="btnEntregar"
                (click)="handleCambiarEstado(pedido.id!, 'entregado')"
                title="Marcar como Entregado"
              >
                üöö
              </button>
              }
              <button
                class="btnAnular"
                (click)="handleCambiarEstado(pedido.id!, 'anulado')"
                title="Anular"
              >
                ‚ùå
              </button>
              }
            </div>
          </td>
        </tr>
        } }
      </tbody>
    </table>
  </div>

  <!-- Modal Detalle -->
  @if (showModal() && pedidoDetalle()) {
  <div class="modalOverlay" (click)="handleCloseModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modalHeader">
        <h2>Detalle del Pedido #{{ pedidoDetalle()?.id }}</h2>
        <button class="modalClose" (click)="handleCloseModal()">‚úï</button>
      </div>

      <div class="modalBody">
        <!-- Informaci√≥n del Cliente -->
        <div class="detailSection">
          <h3>Informaci√≥n del Cliente</h3>
          <p><strong>Negocio:</strong> {{ pedidoDetalle()?.cliente?.nombreNegocio }}</p>
          <p><strong>Contacto:</strong> {{ pedidoDetalle()?.cliente?.nombreContacto }}</p>
          <p>
            <strong>Tel√©fono:</strong> {{ pedidoDetalle()?.cliente?.telefono || 'Sin tel√©fono' }}
          </p>
          <p><strong>Direcci√≥n:</strong> {{ pedidoDetalle()?.cliente?.direccion }}</p>
        </div>

        <!-- Informaci√≥n del Pedido -->
        <div class="detailSection">
          <h3>Informaci√≥n del Pedido</h3>
          <p><strong>Vendedor:</strong> {{ pedidoDetalle()?.vendedor?.nombre }}</p>
          <p>
            <strong>Fecha:</strong>
            {{ pedidoDetalle()?.fechaPedido | date : 'dd MMM. yyyy, h:mm a' }}
          </p>
          <p>
            <strong>Estado:</strong>
            <span
              class="badge"
              [ngClass]="{
                'badgeRegistrado' : pedidoDetalle()?.estado === 'registrado',
                'badgeConfirmado' : pedidoDetalle()?.estado === 'confirmado',
                'badgeEntregado' : pedidoDetalle()?.estado === 'entregado',
                'badgeAnulado' :pedidoDetalle()?.estado === 'anulado',
              }"
            >
              {{ pedidoDetalle()?.estado }}
            </span>
          </p>
          @if (pedidoDetalle()?.observaciones) {
          <p><strong>Observaciones:</strong> {{ pedidoDetalle()?.observaciones }}</p>
          }
        </div>

        <!-- Secci√≥n de Productos CON BOT√ìN MODIFICAR -->
        <div class="detailSection">
          <div class="productosHeader">
            <h3>Productos</h3>

            <!-- ‚úÖ NUEVO: Botones de modo edici√≥n -->
            @if (!modoEdicion()) {
            <button class="btnModificar" (click)="handleActivarEdicion()">‚úèÔ∏è Modificar</button>
            } @else {
            <div class="botonesEdicion">
              <button class="btnGuardar" (click)="handleGuardarCambios()">‚úÖ Guardar</button>
              <button class="btnCancelar" (click)="handleCancelarEdicion()">‚ùå Cancelar</button>
            </div>
            }
          </div>

          <!-- ‚úÖ NUEVO: Formulario para agregar producto (solo en modo edici√≥n) -->
          @if (modoEdicion()) {
          <div class="agregarProductoContainer">
            <div class="formAgregarProducto">
              <div class="inputGroup">
                <label>Producto</label>
                <select
                  class="selectProducto"
                  [value]="productoSeleccionado()?.id || ''"
                  (change)="handleProductoSeleccionado($any($event.target).value)"
                >
                  <option value="">Seleccionar producto...</option>
                  @for (producto of productosDisponibles(); track producto.id) {
                  <option [value]="producto.id">
                    {{ producto.nombre }} ({{ producto.codigo }})
                  </option>
                  }
                </select>
              </div>

              <div class="inputGroup">
                <label>Cantidad</label>
                <input
                  type="number"
                  class="inputCantidad"
                  [value]="cantidadNueva()"
                  (input)="onCantidadInput($event)"
                  min="1"
                />
              </div>

              <div class="inputGroup">
                <label>Precio</label>
                <input
                  type="number"
                  class="inputPrecio"
                  step="0.01"
                  [value]="precioNuevo()"
                  (input)="onPrecioInput($event)"
                  min="0"
                />
              </div>

              <button
                class="btnAgregar"
                (click)="handleAgregarProducto()"
                [disabled]="!productoSeleccionado()"
              >
                ‚ûï Agregar
              </button>
            </div>
          </div>
          }

          <!-- Tabla de productos -->
          <table class="detalleTable">
            <thead>
              <tr>
                <th>Producto</th>
                <th style="width: 100px">Cantidad</th>
                <th style="width: 120px">Precio Unit.</th>
                <th style="width: 120px">Subtotal</th>
                @if (modoEdicion()) {
                <th style="width: 80px">Acciones</th>
                }
              </tr>
            </thead>
            <tbody>
              @for (detalle of detallesEditados(); track detalle.id) {
              <tr>
                <td>
                  <strong>{{ detalle.producto.nombre }}</strong
                  ><br />
                  <span class="codigo">{{ detalle.producto.codigo }}</span>
                </td>

                <!-- ‚úÖ MODO EDICI√ìN: Inputs editables -->
                @if (modoEdicion()) {
                <td>
                  <input
                    type="number"
                    class="inputTableCantidad"
                    [value]="detalle.cantidad"
                    (input)="handleCantidadChange(detalle.id!, $any($event.target).value)"
                    min="1"
                  />
                  <span class="unidad">{{ detalle.producto.unidadMedida }}</span>
                </td>
                <td>
                  <input
                    type="number"
                    class="inputTablePrecio"
                    step="0.01"
                    [value]="detalle.precioUnitario"
                    (input)="handlePrecioChange(detalle.id!, $any($event.target).value)"
                    min="0"
                  />
                </td>
                } @else {
                <!-- MODO VISTA: Solo texto -->
                <td>{{ detalle.cantidad }} {{ detalle.producto.unidadMedida }}</td>
                <td>S/ {{ detalle.precioUnitario | number : '1.2-2' }}</td>
                }

                <td>
                  <strong
                    >S/ {{ detalle.cantidad * detalle.precioUnitario | number : '1.2-2' }}</strong
                  >
                </td>

                <!-- ‚úÖ BOT√ìN ELIMINAR (solo en modo edici√≥n) -->
                @if (modoEdicion()) {
                <td>
                  <button
                    class="btnEliminarDetalle"
                    (click)="handleEliminarDetalle(detalle.id!)"
                    title="Eliminar"
                  >
                    üóëÔ∏è
                  </button>
                </td>
                }
              </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Totales (usa los totales editados si est√° en modo edici√≥n) -->
        <div class="detailSection">
          <div class="totalesModal">
            <div class="totalRow">
              <span>Subtotal:</span>
              <span
                >S/
                {{
                  (modoEdicion() ? totalesEditados().subtotal : pedidoDetalle()?.subtotal)
                    | number : '1.2-2'
                }}</span
              >
            </div>
            <div class="totalRow">
              <span>IGV (18%):</span>
              <span
                >S/
                {{
                  (modoEdicion() ? totalesEditados().igv : pedidoDetalle()?.igv) | number : '1.2-2'
                }}</span
              >
            </div>
            <div class="totalRow totalFinal">
              <span>TOTAL:</span>
              <span
                >S/
                {{
                  (modoEdicion() ? totalesEditados().total : pedidoDetalle()?.total)
                    | number : '1.2-2'
                }}</span
              >
            </div>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btnSecondary" (click)="handleCloseModal()">Cerrar</button>
      </div>
    </div>
  </div>
  }
</div>
